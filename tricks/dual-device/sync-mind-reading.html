<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind Reader - EchoMind 2.0</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="../../css/tricks.css">
    <style>
        .card-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 80%;
            max-height: 80%;
            display: none;
            z-index: 1000;
        }

        .card-display.visible {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: #a96eff;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1001;
        }

        .status-indicator.visible {
            display: block;
        }

        .status-indicator.success {
            color: #4CAF50;
        }

        .status-indicator.error {
            color: #f44336;
        }

        .status-indicator.waiting {
            color: #FFC107;
        }

        .mic-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mic-icon.listening {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mind Reader</h1>
        
        <div class="status-indicator" id="statusIndicator"></div>
        
        <div class="card-display" id="cardDisplay">
            <img src="" alt="Your card will appear here">
        </div>

        <div class="controls">
            <button id="startBtn">Start Mind Reading</button>
            <button id="stopBtn" disabled>Stop Mind Reading</button>
        </div>

        <div class="mic-status">
            <img src="https://www.google.com/images/searchbox/desktop_search_icon.png" alt="Microphone" class="mic-icon" id="micIcon">
            <span id="micStatus">Click to start listening</span>
        </div>

        <a href="../index.html" class="back-button">Back to Tricks</a>
    </div>

    <script>
        const statusIndicator = document.getElementById('statusIndicator');
        const cardDisplay = document.getElementById('cardDisplay');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const micIcon = document.getElementById('micIcon');
        const micStatus = document.getElementById('micStatus');
        let speechHandler = null;
        let isListening = false;

        // Card mapping for speech recognition
        const cardMapping = {
            'ace': 'A',
            'two': '2',
            'three': '3',
            'four': '4',
            'five': '5',
            'six': '6',
            'seven': '7',
            'eight': '8',
            'nine': '9',
            'ten': '10',
            'jack': 'J',
            'queen': 'Q',
            'king': 'K',
            'hearts': 'H',
            'diamonds': 'D',
            'clubs': 'C',
            'spades': 'S'
        };

        // Initialize speech handler
        function initializeSpeechHandler() {
            speechHandler = new SpeechHandler({
                continuous: true,
                onResult: handleSpeechResult,
                onError: (error) => {
                    console.error('Speech error:', error);
                    showStatus('Error: ' + error.error, 'error');
                }
            });
        }

        function handleSpeechResult(transcript) {
            const normalizedTranscript = normalizeTranscript(transcript);
            if (normalizedTranscript) {
                const cardImage = `../../images/cards/${normalizedTranscript}.png`;
                cardDisplay.querySelector('img').src = cardImage;
                cardDisplay.classList.add('visible');
                
                setTimeout(() => {
                    cardDisplay.classList.remove('visible');
                }, 3000);
            }
        }

        function normalizeTranscript(transcript) {
            const words = transcript.toLowerCase().split(' ');
            let rank = '';
            let suit = '';

            // Find rank
            for (const [key, value] of Object.entries(cardMapping)) {
                if (words.includes(key) && !rank) {
                    rank = value;
                    break;
                }
            }

            // Find suit
            for (const [key, value] of Object.entries(cardMapping)) {
                if (words.includes(key) && !suit && ['H', 'D', 'C', 'S'].includes(value)) {
                    suit = value;
                    break;
                }
            }

            if (rank && suit) {
                return `${rank}${suit}`;
            }
            return null;
        }

        function showStatus(message, type = '') {
            statusIndicator.textContent = message;
            statusIndicator.className = 'status-indicator visible';
            if (type) {
                statusIndicator.classList.add(type);
            }
        }

        function hideStatus() {
            statusIndicator.className = 'status-indicator';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const hasPermission = await EchoMind.PermissionsHandler.requestMicrophonePermission();
                if (hasPermission) {
                    initializeSpeechHandler();
                    showStatus('Microphone access granted', 'success');
                    setTimeout(hideStatus, 2000);
                } else {
                    showStatus('Microphone access denied', 'error');
                }
            } catch (error) {
                console.error('Error initializing:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        });

        // Start button click handler
        startBtn.addEventListener('click', () => {
            speechHandler.start();
            isListening = true;
            micIcon.classList.add('listening');
            micStatus.textContent = 'Listening...';
            startBtn.disabled = true;
            stopBtn.disabled = false;
            showStatus('Mind reading activated', 'success');
            setTimeout(hideStatus, 2000);
        });

        // Stop button click handler
        stopBtn.addEventListener('click', () => {
            speechHandler.stop();
            isListening = false;
            micIcon.classList.remove('listening');
            micStatus.textContent = 'Click to start listening';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            showStatus('Mind reading deactivated', 'success');
            setTimeout(hideStatus, 2000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (speechHandler) {
                speechHandler.cleanup();
            }
        });
    </script>
</body>
</html>
